<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>갓투어 자동 견적</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- 엑셀(xlsx) 읽기 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: #f5f5f7;
    }
    .app {
      max-width: 720px;
      margin: 0 auto;
    }
    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 20px 20px 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
    }
    h1 {
      font-size: 22px;
      margin: 0 0 4px;
    }
    .subtitle {
      font-size: 13px;
      color: #777;
      margin-bottom: 16px;
      line-height: 1.5;
    }
    label {
      display: block;
      font-size: 13px;
      margin-bottom: 6px;
      font-weight: 600;
    }
    select, input[type="number"] {
      width: 100%;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 14px;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s;
      background: #fff;
    }
    select:focus, input:focus {
      border-color: #333;
      box-shadow: 0 0 0 1px #3332;
    }
    .field {
      margin-bottom: 12px;
    }
    .row {
      display: flex;
      gap: 10px;
    }
    .col {
      flex: 1;
    }
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #f0f0f3;
      color: #555;
      margin-left: 6px;
    }
    .status {
      font-size: 12px;
      color: #888;
      margin-bottom: 10px;
    }
    .status.ok { color: #2b7a0b; }
    .status.err { color: #c62828; }
    .range-note {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }
    .error-msg {
      font-size: 12px;
      color: #c62828;
      margin-top: 4px;
    }
    .result {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px dashed #ddd;
      font-size: 14px;
    }
    .result-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .result-label {
      color: #555;
    }
    .result-value {
      font-weight: 600;
    }
    .result-total {
      font-size: 17px;
      font-weight: 700;
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid #eee;
    }
    .note {
      margin-top: 6px;
      font-size: 11px;
      color: #888;
      line-height: 1.4;
    }
    .footer {
      margin-top: 10px;
      font-size: 11px;
      color: #aaa;
      text-align: right;
    }
    @media (max-width: 480px) {
      .card { padding: 16px 14px 12px; }
      h1 { font-size: 18px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>갓투어 자동 견적</h1>
      <div class="subtitle">
        투어를 선택하고 성인 / 아동 인원만 입력하면<br>
        예약금 · 현장 잔금 · 총 금액이 자동으로 계산됩니다.
      </div>

      <div id="loadStatus" class="status">요금표(엑셀) 불러오는 중...</div>

      <!-- 투어 선택 -->
      <div class="field">
        <label for="tourSelect">① 투어 선택</label>
        <select id="tourSelect" disabled>
          <option value="">데이터 로딩 중...</option>
        </select>
      </div>

      <!-- 인원 입력 -->
      <div class="row">
        <div class="col">
          <div class="field">
            <label for="adultInput">② 성인 인원</label>
            <input type="number" id="adultInput" min="1" value="2" disabled />
            <div id="rangeNote" class="range-note"></div>
          </div>
        </div>
        <div class="col">
          <div class="field">
            <label for="childInput">아동 인원</label>
            <input type="number" id="childInput" min="0" value="0" disabled />
          </div>
        </div>
      </div>

      <div id="errorMsg" class="error-msg"></div>

      <!-- 결과 -->
      <div class="result">
        <div class="result-line">
          <div class="result-label">성인 예약금</div>
          <div class="result-value" id="adultDeposit">₩ 0</div>
        </div>
        <div class="result-line">
          <div class="result-label">성인 잔금</div>
          <div class="result-value" id="adultBalance">₩ 0</div>
        </div>
        <div class="result-line">
          <div class="result-label">아동 예약금</div>
          <div class="result-value" id="childDeposit">₩ 0</div>
        </div>
        <div class="result-line">
          <div class="result-label">아동 잔금</div>
          <div class="result-value" id="childBalance">₩ 0</div>
        </div>

        <div class="result-total" id="totalDeposit">총 예약금: ₩ 0</div>
        <div class="result-line">
          <div class="result-label">현장 잔금 합계</div>
          <div class="result-value" id="totalBalance">₩ 0</div>
        </div>
        <div class="result-line">
          <div class="result-label">총 투어 금액 (예약금+잔금)</div>
          <div class="result-value" id="grandTotal">₩ 0</div>
        </div>
        <div class="result-line">
          <div class="result-label">1인당 금액 (성인+아동 기준)</div>
          <div class="result-value" id="perPerson">₩ 0</div>
        </div>

        <div class="note">
          ※ 요금표는 갓투어 내부 엑셀 기준으로 자동 계산됩니다.<br>
          ※ 성인 요금은 <strong>성인 인원수</strong> 기준, 아동 요금은 별도 1인 요금으로 계산합니다.<br>
          ※ 실제 결제 전에는 갓투어에서 최종 금액을 다시 한 번 안내드립니다.
        </div>
      </div>
    </div>

    <div class="footer">
      © GodTour Cebu
    </div>
  </div>

  <script>
    // === 설정: 서버에 올려둘 엑셀 파일 이름 ===================
    const EXCEL_URL = "gadtour-quote.xlsx"; 
    // 같은 폴더에 이 이름으로 엑셀 올려두면 됨
    // ========================================================

    let TOURS = {}; // { "체험 다이빙": {minPax, maxPax, adults:{2:{...}}, child:{...}} }

    const $status       = document.getElementById("loadStatus");
    const $tourSelect   = document.getElementById("tourSelect");
    const $adultInput   = document.getElementById("adultInput");
    const $childInput   = document.getElementById("childInput");
    const $rangeNote    = document.getElementById("rangeNote");
    const $errorMsg     = document.getElementById("errorMsg");

    const $adultDeposit  = document.getElementById("adultDeposit");
    const $adultBalance  = document.getElementById("adultBalance");
    const $childDeposit  = document.getElementById("childDeposit");
    const $childBalance  = document.getElementById("childBalance");
    const $totalDeposit  = document.getElementById("totalDeposit");
    const $totalBalance  = document.getElementById("totalBalance");
    const $grandTotal    = document.getElementById("grandTotal");
    const $perPerson     = document.getElementById("perPerson");

    function formatKRW(value) {
      const num = Number(value) || 0;
      return "₩ " + num.toLocaleString("ko-KR");
    }

    function clearResult() {
      $adultDeposit.textContent = "₩ 0";
      $adultBalance.textContent = "₩ 0";
      $childDeposit.textContent = "₩ 0";
      $childBalance.textContent = "₩ 0";
      $totalDeposit.textContent = "총 예약금: ₩ 0";
      $totalBalance.textContent = "₩ 0";
      $grandTotal.textContent   = "₩ 0";
      $perPerson.textContent    = "₩ 0";
    }

    function parseLabel(label) {
      if (!label) return null;
      label = String(label).trim();
      if (!label) return null;

      // "...아동" 인 경우 → 아동 요금
      if (label.endsWith("아동")) {
        return { base: label.slice(0, -2), isChild: true, pax: null };
      }
      // 맨 끝에 숫자 붙은 경우 (예: 체험 다이빙2, 고래상어10)
      const m = label.match(/^(.*?)(\d+)$/);
      if (m) {
        return {
          base: m[1].trim(),
          isChild: false,
          pax: parseInt(m[2], 10)
        };
      }
      // 그 외 (공항픽업3박 투어 이런 거) → 숫자 못 뽑으면 나중에 인원 컬럼으로 시도
      return { base: label, isChild: false, pax: null };
    }

    function buildToursFromRows(rows) {
      const tmp = {}; // {baseName: {adults:{}, child:{...}}}

      rows.forEach(row => {
        const label = row["Unnamed: 0"];
        if (!label) return;

        const parsed = parseLabel(label);
        if (!parsed) return;
        const { base, isChild, pax: paxFromLabel } = parsed;

        if (!tmp[base]) {
          tmp[base] = { adults: {}, child: null };
        }

        const dep = row["예약금"];
        const bal = row["투어잔금"];
        const tot = row["총 투여금액"];

        const allEmpty = (dep == null || dep === "" || dep === "무료제공") &&
                         (bal == null || bal === "" || bal === "무료제공") &&
                         (tot == null || tot === "");
        if (allEmpty) return;

        const deposit = (dep === "무료제공") ? 0 : Number(dep) || 0;
        const balance = (bal === "무료제공") ? 0 : Number(bal) || 0;
        const total   = Number(tot) || (deposit + balance);

        if (isChild) {
          tmp[base].child = { deposit, balance, total };
          return;
        }

        let pax = paxFromLabel;
        if (pax == null) {
          const paxIn = row["인원"];
          if (typeof paxIn === "number" && Number.isFinite(paxIn)) {
            pax = paxIn;
          }
        }
        if (pax == null) return;

        tmp[base].adults[pax] = { deposit, balance, total };
      });

      // min/max 인원 계산 + 쓸모 없는 투어 제거
      TOURS = {};
      Object.keys(tmp).forEach(name => {
        const adults = tmp[name].adults;
        const paxKeys = Object.keys(adults).map(v => parseInt(v, 10)).sort((a,b)=>a-b);
        if (!paxKeys.length) return;

        TOURS[name] = {
          adults,
          child: tmp[name].child,
          minPax: paxKeys[0],
          maxPax: paxKeys[paxKeys.length - 1]
        };
      });
    }

    function populateTourSelect() {
      $tourSelect.innerHTML = "";
      const names = Object.keys(TOURS).sort((a,b)=>a.localeCompare(b, "ko-KR"));

      if (!names.length) {
        $tourSelect.innerHTML = `<option value="">투어 데이터를 찾을 수 없습니다</option>`;
        $tourSelect.disabled = true;
        $adultInput.disabled = true;
        $childInput.disabled = true;
        return;
      }

      const ph = document.createElement("option");
      ph.value = "";
      ph.textContent = "투어를 선택해주세요";
      $tourSelect.appendChild(ph);

      names.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        $tourSelect.appendChild(opt);
      });

      $tourSelect.disabled = false;
      $adultInput.disabled = false;
      $childInput.disabled = false;

      $status.textContent = `요금표 로딩 완료 (투어 ${names.length}개)`;
      $status.className = "status ok";
    }

    function updateRangeNote() {
      const name = $tourSelect.value;
      if (!name || !TOURS[name]) {
        $rangeNote.textContent = "";
        return;
      }
      const t = TOURS[name];
      $rangeNote.textContent = `※ 성인 ${t.minPax}명 ~ ${t.maxPax}명까지 요금이 등록되어 있습니다.`;
      if (Number($adultInput.value) < t.minPax || Number($adultInput.value) > t.maxPax) {
        $adultInput.value = t.minPax;
      }
    }

    function calculate() {
      clearResult();
      $errorMsg.textContent = "";

      const name = $tourSelect.value;
      if (!name || !TOURS[name]) return;

      const t = TOURS[name];

      const adultCount = parseInt($adultInput.value, 10) || 0;
      const childCount = parseInt($childInput.value, 10) || 0;

      if (adultCount <= 0) {
        $errorMsg.textContent = "성인 인원은 1명 이상이어야 합니다.";
        return;
      }
      if (adultCount < t.minPax || adultCount > t.maxPax) {
        $errorMsg.textContent = `이 투어는 성인 ${t.minPax}~${t.maxPax}명까지만 요금이 등록되어 있습니다.`;
        return;
      }

      const adultRow = t.adults[adultCount];
      if (!adultRow) {
        $errorMsg.textContent = "해당 성인 인원에 대한 요금이 존재하지 않습니다.";
        return;
      }

      // 성인 요금
      const aDep = adultRow.deposit;
      const aBal = adultRow.balance;
      const aTot = adultRow.total || (aDep + aBal);

      // 아동 요금
      let cDep = 0, cBal = 0, cTot = 0;
      if (childCount > 0) {
        if (t.child) {
          cDep = t.child.deposit * childCount;
          cBal = t.child.balance * childCount;
          cTot = t.child.total * childCount;
        } else {
          // 아동 요금이 엑셀에 없으면 그냥 0 처리
          $errorMsg.textContent = "이 투어는 별도 아동 요금이 등록되어 있지 않습니다. (성인 요금만 계산됨)";
        }
      }

      const totalDep = aDep + cDep;
      const totalBal = aBal + cBal;
      const grand    = aTot + cTot;

      $adultDeposit.textContent = formatKRW(aDep);
      $adultBalance.textContent = formatKRW(aBal);
      $childDeposit.textContent = formatKRW(cDep);
      $childBalance.textContent = formatKRW(cBal);

      $totalDeposit.textContent = "총 예약금: " + formatKRW(totalDep);
      $totalBalance.textContent = formatKRW(totalBal);
      $grandTotal.textContent   = formatKRW(grand);

      const totalPax = adultCount + childCount;
      if (totalPax > 0) {
        $perPerson.textContent = formatKRW(Math.round(grand / totalPax));
      } else {
        $perPerson.textContent = "₩ 0";
      }
    }

    async function loadExcel() {
      try {
        $status.textContent = "요금표(엑셀) 불러오는 중...";
        const res = await fetch(EXCEL_URL);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const arrayBuffer = await res.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: "array" });

        const sheetName = workbook.SheetNames[0]; // 첫 번째 시트 사용 (지금 엑셀은 '투어 가격 ')
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { defval: null });

        buildToursFromRows(rows);
        populateTourSelect();
        clearResult();
      } catch (err) {
        console.error(err);
        $status.textContent = "엑셀 파일을 불러오는 데 실패했습니다. 파일 이름/위치를 확인해주세요.";
        $status.className = "status err";
        $tourSelect.disabled = true;
        $adultInput.disabled = true;
        $childInput.disabled = true;
      }
    }

    // 이벤트
    document.addEventListener("DOMContentLoaded", () => {
      loadExcel();
      $tourSelect.addEventListener("change", () => {
        updateRangeNote();
        calculate();
      });
      $adultInput.addEventListener("input", () => {
        calculate();
      });
      $childInput.addEventListener("input", () => {
        calculate();
      });
    });
  </script>
</body>
</html>
